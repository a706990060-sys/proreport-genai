# 🔧 修复"登录已过期"问题 - 完整指南

## 🎯 问题原因

登录后创建项目时提示"登录已过期"，通常是因为：

1. **JWT_SECRET不匹配**：登录时使用的JWT_SECRET与验证时使用的不同
2. **Token未正确保存**：登录后token没有保存到LocalStorage
3. **Token未正确传递**：API请求时token没有正确添加到请求头
4. **后端重启**：后端重启后JWT_SECRET改变，导致旧token失效

## ✅ 已添加的修复

1. **前端调试日志**：记录token保存和传递过程
2. **后端调试日志**：记录token生成和验证过程
3. **错误处理改进**：更清晰的错误提示

## 🔍 排查步骤

### 步骤1：检查后端JWT_SECRET配置

1. 打开 `server/.env` 文件
2. 确认 `JWT_SECRET` 已设置，例如：
   ```env
   JWT_SECRET=proreport-secret-key-change-this-in-production
   ```
3. 如果不存在，添加这一行

### 步骤2：重启后端服务

1. 停止后端服务（Ctrl+C）
2. 重新启动：
   ```bash
   cd F:\ProReport-GenAI\server
   npm run dev
   ```
3. 查看后端日志，应该看到：
   ```
   JWT_SECRET配置: 已设置(XXX字符)
   ```

### 步骤3：清除旧token并重新登录

1. 打开浏览器开发者工具（F12）
2. Application → Local Storage → `http://localhost:3000`
3. 删除 `auth_token` 键
4. 刷新页面
5. 重新登录

### 步骤4：查看调试日志

**前端日志（浏览器控制台）：**
- 登录时：应该看到token保存成功的日志
- 创建项目时：应该看到token传递的日志

**后端日志（后端终端）：**
- 登录时：应该看到token生成的日志
- 创建项目时：应该看到token验证的日志

## 🛠️ 快速修复方法

### 方法1：确保JWT_SECRET一致

1. 编辑 `server/.env` 文件
2. 设置固定的JWT_SECRET：
   ```env
   JWT_SECRET=proreport-secret-key-2024
   ```
3. 重启后端服务
4. 清除浏览器token并重新登录

### 方法2：检查后端.env文件

确保 `server/.env` 文件存在且包含：

```env
PORT=3001
GEMINI_API_KEY=你的API密钥
JWT_SECRET=proreport-secret-key-change-this-in-production
FRONTEND_URL=http://localhost:3000
NODE_ENV=development
DATA_PATH=./data
```

### 方法3：完全重置

1. **清除浏览器数据**：
   - Application → Local Storage → 删除所有键
   - Application → Session Storage → 删除所有键

2. **重启后端**：
   ```bash
   cd F:\ProReport-GenAI\server
   npm run dev
   ```

3. **重新注册/登录**：
   - 注册新账号或使用已有账号登录
   - 查看控制台和后端日志确认token正确

## 📋 验证清单

- [ ] `server/.env` 文件存在且包含 `JWT_SECRET`
- [ ] 后端服务正在运行
- [ ] 浏览器LocalStorage中有 `auth_token`
- [ ] 前端控制台显示token已保存
- [ ] 后端日志显示token已生成
- [ ] 创建项目时前端控制台显示token已传递
- [ ] 创建项目时后端日志显示token验证成功

## 🐛 如果仍然失败

请提供以下信息：

1. **后端终端日志**（完整的启动和请求日志）
2. **浏览器控制台日志**（Console标签的完整输出）
3. **网络请求详情**（Network标签中 `/api/projects` 请求）
4. **server/.env文件内容**（隐藏敏感信息）

## 💡 预防措施

1. **固定JWT_SECRET**：不要频繁更改JWT_SECRET
2. **环境变量管理**：确保.env文件正确配置
3. **定期检查**：定期检查token是否正常
4. **错误监控**：关注控制台和后端日志

