# 🔍 问题诊断指南

请按照以下步骤收集错误信息，以便准确定位问题：

## 📋 步骤1：检查浏览器控制台

1. **打开浏览器开发者工具**
   - 按 `F12` 或右键点击页面 → "检查"
   - 切换到 **"Console"**（控制台）标签

2. **点击"生成本节内容"按钮**

3. **复制所有错误信息**
   - 查找红色错误信息
   - 复制完整的错误消息
   - 特别注意以下信息：
     - `FUNCTION_INVOCATION_TIMEOUT`
     - `504 (Gateway Timeout)`
     - `500 (Internal Server Error)`
     - `403 (Forbidden)`
     - `GEMINI_API_KEY`
     - `MONGODB_URI`

## 📋 步骤2：检查网络请求

1. **在开发者工具中切换到 "Network"（网络）标签**

2. **点击"生成本节内容"按钮**

3. **找到 `/api/generate/section` 请求**
   - 点击该请求
   - 查看 **"Headers"**（请求头）标签
   - 查看 **"Response"**（响应）标签
   - 查看 **"Preview"**（预览）标签

4. **记录以下信息**：
   - **Status Code**（状态码）：例如 `504`、`500`、`403`
   - **Response Time**（响应时间）：例如 `10.5s`、`60s`
   - **Response Body**（响应内容）：完整的错误消息

## 📋 步骤3：检查 Vercel 部署日志

1. **访问 Vercel 控制台**
   - https://vercel.com/dashboard
   - 登录你的账号

2. **进入项目**
   - 点击项目 `proreport-genai`

3. **查看部署日志**
   - 点击 **"Deployments"** 标签
   - 点击最新的部署
   - 查看 **"Build Logs"**（构建日志）
   - 查看 **"Function Logs"**（函数日志）

4. **查找错误信息**：
   - TypeScript 编译错误（`TS2305`、`TS2307` 等）
   - 运行时错误
   - 超时错误

## 📋 步骤4：检查环境变量

1. **在 Vercel 控制台**
   - 点击 **"Settings"** → **"Environment Variables"**

2. **确认以下环境变量已配置**：
   - ✅ `MONGODB_URI` - MongoDB 连接字符串
   - ✅ `GEMINI_API_KEY` - Gemini API 密钥
   - ⚠️ `JWT_SECRET` - JWT 密钥（建议设置）

3. **检查环境变量值**：
   - 点击每个环境变量
   - 确认值不为空
   - 确认已应用到所有环境（Production、Preview、Development）

## 📋 步骤5：检查 Vercel 计划

1. **在 Vercel 控制台**
   - 点击右上角头像 → **"Settings"** → **"Billing"**

2. **确认你的计划类型**：
   - **Hobby（免费）**：最大超时 10 秒
   - **Pro**：最大超时 60 秒

3. **如果使用免费计划**：
   - `maxDuration: 60` 在 `vercel.json` 中不会生效
   - 实际超时限制仍然是 10 秒
   - 这是导致 504 超时的常见原因

## 📋 步骤6：测试 API 端点

1. **测试健康检查端点**
   - 在浏览器中访问：`https://proreport-genai.vercel.app/api/health`
   - 应该返回：`{"success":true,"message":"API is running"}`

2. **如果健康检查失败**：
   - 说明后端函数本身有问题
   - 检查 Vercel 部署日志

## 🔍 常见问题及解决方案

### 问题1：`FUNCTION_INVOCATION_TIMEOUT` 或 `504 Gateway Timeout`

**可能原因**：
1. Vercel 免费计划超时限制（10秒）
2. Gemini API 响应时间过长
3. 参考文件过大导致处理时间过长

**解决方案**：
- 如果使用免费计划，需要升级到 Pro 计划（支持 60 秒）
- 或优化生成要求：
  - 简化生成要求
  - 减少参考文件数量
  - 关闭联网搜索

### 问题2：`GEMINI_API_KEY is not configured`

**解决方案**：
- 在 Vercel 环境变量中配置 `GEMINI_API_KEY`
- 参考：`配置GEMINI_API_KEY-紧急修复.md`

### 问题3：`Your API key was reported as leaked`

**解决方案**：
- 创建新的 API 密钥
- 在 Vercel 中更新 `GEMINI_API_KEY`
- 参考：`修复API密钥泄露问题.md`

### 问题4：TypeScript 编译错误

**解决方案**：
- 检查 `api/types.ts` 是否包含所有必需的类型定义
- 检查 `api/index.ts` 中的导入语句

### 问题5：MongoDB 连接失败

**解决方案**：
- 检查 `MONGODB_URI` 是否正确
- 检查 MongoDB Atlas 网络访问配置
- 参考：`MongoDB配置指南.md`

## 📤 提供诊断信息

请将以下信息提供给我：

1. **浏览器控制台错误**（截图或复制文本）
2. **网络请求详情**（Status Code、Response Time、Response Body）
3. **Vercel 部署日志**（Build Logs 和 Function Logs 中的错误）
4. **环境变量状态**（是否已配置 `MONGODB_URI` 和 `GEMINI_API_KEY`）
5. **Vercel 计划类型**（Hobby 还是 Pro）
6. **健康检查结果**（`/api/health` 的响应）

---

**有了这些信息，我就能准确定位问题并提供解决方案！** 🎯

